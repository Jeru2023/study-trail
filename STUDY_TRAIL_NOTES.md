# 学迹（Study Trail）项目总规

## 基本规则
- Your code must use the UTF-8 encoding format. Always run 'chcp 65001' in powershell as your first command. 
- 使用 Node.js 实现后端。
- 前端 HTML、CSS、JavaScript 采用模块化拆分。
- 数据统一存储在 MySQL 数据库，Config file: `.env`
- 每次完成修改后必须提交一次代码。GIT路径为C:\Program Files\Git
- 每个功能需求都要记录在 Markdown 文档中，并在实现对应功能时更新。
- 所有用户提出的新需求都要在本文件中同步更新。
- 启动 Node.js 服务时使用 Start-Process ... node.exe src/server.js -WindowStyle Hidden 方式后台运行，避免命令行阻塞。
- JavaScript/HTML 文件必须以 UTF-8（无 BOM）保存，使用 VS Code 等工具确认编码；脚本写文件时显式传入 'utf8'，避免中文乱码。

## 功能需求记录

### 功能 1：注册与登录
- 角色：学生、家长。
- 家长使用邮箱注册账号，可管理多个学生子账号。
- 学生账号无需邮箱，通过家长创建。
- 登录统一使用登录名 + 密码。
- 首页先让用户选择身份（学生 / 家长），参考提供的设计图制作登录页。
- 注册入口仅对家长开放；学生身份仅展示登录表单。
- 注册失败时需要给出明确友好的提示信息，避免出现浏览器默认的 “Failed to fetch”。
- 后端需实现注册、登录接口，并与 MySQL 数据库交互。

### 功能 2：家长后台与打卡任务管理
- 家长登录成功后进入管理控制台（顶部 Topbar + 左侧 Sidebar + 右侧内容区）。
- 控制台风格参考提供的设计稿，配色延续登录页的绿色体系。
- Sidebar 首个菜单“打卡配置”对应任务管理，默认显示任务列表，支持新增、编辑、删除。
- 新增、编辑、删除操作完成后自动返回列表并刷新数据。
- 其他菜单暂可占位，后续迭代补充。
- 项目中广泛使用中文文案，开发时务必使用 UTF-8 编码保存文件，避免出现乱码。
- 多任务开发时需确保服务进程真正运行，避免误以为已启动导致流程阻塞。

### 功能 3：学生账号管理
- 左侧菜单新增“学生账号”入口，家长可在控制台中管理子女账号。
- 学生账号信息包括姓名、登录名、密码。
- 支持学生账号的新增、编辑、删除、列表查看。
- 所有操作完成后需自动刷新列表，保持体验一致。

### 功能 4：任务关联管理
- 家长控制台新增“任务关联”导航项，用于维护学生与打卡任务的匹配关系。
- 支持查看学生与任务的对应列表，以及新增、编辑（覆盖重新选择的任务集合）和删除操作。
- 新增关联时先选择学生，再多选一个或多个打卡任务；若学生或任务列表为空，界面会提示先完成基础配置。
- 新建表 `student_tasks`（列：parent_id、student_id、task_id 及时间戳），并对 `student_id + task_id` 建唯一索引。

### 需求 5：学生打卡页面
- 学生登录后跳转至 student.html 页面集中展示当日任务列表，可查看积分、有效期和子任务状态。
- 后端新增 student_task_entries 与 student_task_entry_photos 两张表，记录学生自建子任务、打卡时间以及上传的图片信息。
- 新增 API：GET /api/student/daily-tasks 查询每日任务，POST /api/student/daily-tasks/:taskId/subtasks 创建子任务，PATCH /api/student/subtasks/:entryId/start 记录开始时间，POST /api/student/subtasks/:entryId/complete 完成并上传照片。
- 学生前端支持新增子任务、开始计时、完成提交（含多图上传与完成心得），并展示已完成任务的耗时及照片链接。

### 需求 6：上传预览升级
- 学生打卡弹窗改为卡片式拖拽区域，支持点击或拖放上传，实时展示缩略图预览，视频文件在预览时默认静音播放。
- 后端允许同时接收图片与视频，student_task_entry_photos 表新增 file_type 字段存储 MIME，用于区分展示类型。
- 完成提交后返回 proof 列表（兼容旧 photos 字段），前端任务列表中按网格展示图片和视频缩略图，并支持补充上传。
- 追加文件上限、大小校验与提示，提示文案同步更新，避免超过 6 个文件或 30MB 单文件的提交。
- 上传接口新增更明确的错误提示：会话失效时直接提示重新登录，后台记录异常日志，同时对 Windows 系统生成的路径统一标准化，确保附件始终可访问。

### 需求 7：家长打卡审批
- 家长后台侧边栏新增“打卡审批”，卡片内展示任务标题、子任务名称与孩子信息，支持快速切换查看当日所有记录。
- 附件预览统一转为绝对 URL，兼容 Windows 上传目录，照片/视频均可直接打开新标签预览，驳回后仍保留原始附件。
- 审批操作支持填写备注（可选），通过或驳回时一并保存；驳回不再清空记录，学生端会看到驳回原因并可在原子任务上重新提交；通过时仅提示审批成功，不再宣称立即发放积分。
- 家长可手动删除未审批或已驳回的记录（已通过的记录不允许删除），按钮颜色使用橙色/红色区分驳回和删除操作，并提供删除前确认。
- 列表支持实时刷新与手动刷新，审批结果即时同步到学生端页面。

### 需求 8：积分商城
- 家长与学生均可在各自入口看到“积分商城”模块：家长端位于管理后台导航，学生端在前台页面提供只读浏览。
- 家长端需提供完整的奖品管理能力，包含奖励名称、所需积分、库存/限兑数量、上架状态及可选描述，支持增删改查与列表分页筛选。
- 学生端只能查看当前上架的奖励列表（含所需积分与剩余库存），暂不支持兑换操作。
- 后端需新增对应的数据表（如 `reward_items`），并按照家长/学生角色做权限校验以及上架状态过滤。
- 列表、表单交互和文案需遵循项目统一的视觉与编码规范，确保 UTF-8 中文显示正常。

### 需求 9：积分管理中心
- 家长后台新增“积分管理”导航，可查看名下学生的积分余额、累计获得/使用情况及最后更新时间。
- 支持家长针对每位学生手动加减积分，需填写可选备注并校验余额，所有调整写入 `student_points_history`。
- 在同一页面为学生发起积分商城奖励兑换，扣减对应积分并同步奖品库存状态。
- 积分历史列表需展示来源分类（打卡、手动、兑换）与详情，确保积分流水可追溯。

### 需求 10：数据分析看板
- 家长后台新增“数据分析”看板，集中展示积分运营情况。
- 看板需提供今日、近 7 日、近 30 日三个时间段的学生积分排行榜，排行榜支持多选过滤积分来源（打卡积分、其他积分）。
- 支持快速检索并查看单个学生近 3 个月的积分流水与趋势，可按积分来源筛选。
- 增补核心统计卡片（如累计发放、手动调整、兑换消耗等）以及简单图表或热力展示，帮助家长理解积分使用状况。
- 看板交互需与现有后台风格一致，图表可使用原生 Canvas/CSS 实现，无外部依赖。

### 需求 11：学生每日学习计划
- 学生在每日打卡前需先提交“每日计划”，为当日任务添加子任务清单。
- “每日计划”经家长审核通过后，学生才能进入打卡流程；家长可在后台查看并审批。
- 每日计划包含多个子任务，仅需记录标题与所属任务，不包含备注。
- 后端需提供计划的创建、保存、提交、审批接口，并保证状态流转：草稿 → 已提交 → 审批通过/驳回。
